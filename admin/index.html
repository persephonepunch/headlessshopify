<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decap CMS | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <style>
        aside a span {
            display: inline-flex !important;
            justify-content: center;
            align-items: center
        }

        aside a span svg {
            display: none !important;
        }

        aside a span::before {
            font-family: "Font Awesome 5 Free";
            font-size: 1rem;
            /* Regular (400) only includes some icons. Solid (900) has the rest of the free ones */
            font-weight: 900;
        }

        aside a[href^="#/collections/"] span::before {
            content: "\f15b";
        }

        aside a[href="#/collections/pages"] span::before {
            content: "\f15c";
        }

        aside a[href="#/collections/settings"] span::before {
            content: "\f53f";
        }

        div[class*="ViewControlsSection"] {
            display: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="widgets.css" rel="stylesheet">
</head>
<body>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decap CMS | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <style>
        aside a span {
            display: inline-flex !important;
            justify-content: center;
            align-items: center
        }

        aside a span svg {
            display: none !important;
        }

        aside a span::before {
            font-family: "Font Awesome 5 Free";
            font-size: 1rem;
            font-weight: 900;
        }

        aside a[href^="#/collections/"] span::before {
            content: "\f15b";
        }

        aside a[href="#/collections/pages"] span::before {
            content: "\f15c";
        }

        aside a[href="#/collections/settings"] span::before {
            content: "\f53f";
        }

        div[class*="ViewControlsSection"] {
            display: none;
        }

        /* Login form styles */
        .xano-login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Open Sans', sans-serif;
        }

        .xano-login-form {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .xano-login-form h1 {
            text-align: center;
            color: #333;
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        .xano-login-form .form-group {
            margin-bottom: 1rem;
        }

        .xano-login-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }

        .xano-login-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .xano-login-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .xano-login-form button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .xano-login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .xano-login-form button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .xano-error {
            color: #e74c3c;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #fadbd8;
            border-radius: 4px;
            text-align: center;
        }

        .xano-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="widgets.css" rel="stylesheet">
</head>
<body>

<div id="app"></div>

<script>
    // Xano authentication handler
    class XanoAuthHandler {
        constructor() {
            this.token = localStorage.getItem('xano_token');
            this.user = JSON.parse(localStorage.getItem('xano_user') || '{}');
            this.permissions = JSON.parse(localStorage.getItem('xano_permissions') || '{}');
        }

        async login(email, password) {
            try {
                const response = await fetch('/.netlify/functions/xano-auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Login failed');
                }

                const data = await response.json();
                
                // Store token and user info
                localStorage.setItem('xano_token', data.token);
                localStorage.setItem('xano_user', JSON.stringify(data.user));
                
                this.token = data.token;
                this.user = data.user;

                // Get user permissions
                await this.fetchPermissions();

                return true;
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        async fetchPermissions() {
            try {
                const response = await fetch('/.netlify/functions/xano-auth/permissions', {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${this.token}` }
                });

                if (!response.ok) throw new Error('Failed to fetch permissions');

                const data = await response.json();
                localStorage.setItem('xano_permissions', JSON.stringify(data.permissions || {}));
                this.permissions = data.permissions || {};
            } catch (error) {
                console.warn('Could not fetch permissions:', error);
                this.permissions = {};
            }
        }

        isLoggedIn() {
            return !!this.token;
        }

        canAccessCollection(collection) {
            if (this.user.role === 'admin') return true;
            const perms = this.permissions[collection];
            return perms && perms.read;
        }

        logout() {
            localStorage.removeItem('xano_token');
            localStorage.removeItem('xano_user');
            localStorage.removeItem('xano_permissions');
            window.location.reload();
        }
    }

    const authHandler = new XanoAuthHandler();

    // Show login form if not logged in
    if (!authHandler.isLoggedIn()) {
        document.body.innerHTML = `
            <div class="xano-login-container">
                <div class="xano-login-form">
                    <h1>Admin Login</h1>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        <button type="submit" id="login-btn">Sign In</button>
                        <div id="error-message"></div>
                    </form>
                </div>
            </div>
        `;

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = document.getElementById('login-btn');
            const errorDiv = document.getElementById('error-message');

            btn.disabled = true;
            btn.innerHTML = '<div class="xano-loading"></div>';
            errorDiv.innerHTML = '';

            try {
                await authHandler.login(email, password);
                window.location.reload();
            } catch (error) {
                errorDiv.innerHTML = `<div class="xano-error">${error.message}</div>`;
                btn.disabled = false;
                btn.innerHTML = 'Sign In';
            }
        });
    } else {
        // Load Decap CMS with token
        document.body.innerHTML = '<div id="cms"></div>';
    }
</script>

<!-- Load Decap CMS only if authenticated -->
<script>
    if (authHandler && authHandler.isLoggedIn()) {
        // Dynamically load Decap CMS
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js';
        script.onload = () => {
            // Configure Decap CMS
            window.CMS_CONFIG = {
                backend: {
                    name: 'github',
                    repo: 'persephonepunch/headlessshopify',
                    branch: 'main'
                },
                local_backend: false,
                media_folder: 'theme/assets/images',
                public_folder: '/assets/images'
            };

            // Register custom preview styles and widgets
            if (window.CMS) {
                setTimeout(() => {
                    CMS.registerPreviewStyle("preview.css");
                }, 500);
            }
        };
        document.head.appendChild(script);

        // Load immutable
        const immutableScript = document.createElement('script');
        immutableScript.src = 'https://cdn.jsdelivr.net/npm/immutable@4.0.0-rc.12/dist/immutable.min.js';
        document.head.appendChild(immutableScript);

        // Load custom widgets
        setTimeout(() => {
            const priceWidget = document.createElement('script');
            priceWidget.src = 'widgets/price.js';
            document.body.appendChild(priceWidget);

            const propTableWidget = document.createElement('script');
            propTableWidget.src = 'widgets/prop-table.js';
            document.body.appendChild(propTableWidget);

            const propValuesWidget = document.createElement('script');
            propValuesWidget.src = 'widgets/prop-values.js';
            document.body.appendChild(propValuesWidget);
        }, 1000);
    }
</script>

</body>
</html>
</body>
</html>
